<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TPN Calculator</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'calculator/style.css' %}">
</head>
<body>
  <div class="navbar">
    <input type="checkbox" id="nav-toggle" class="navbar-toggle" />
    <label for="nav-toggle" class="hamburger">
      <div></div><div></div><div></div>
    </label>

    
    <div class="navbar-buttons navbar-menu">
      <div><a href="/">üè† Home</a></div>
      <button onclick="window.print()">üñ∂</button>
      <button onclick="printResult()">Only</button>
      <button onclick="downloadPDF()">üìÑ PDF</button>
      <label>üåó <input type="checkbox" id="themeToggle"></label>
    </div>
  </div>

  <div class="header-inputs">
    <div><label>Name:</label><input type="text" name="user_name" /></div>
    <div><label>ID:</label><input type="text" name="user_id" /></div>
    <div><label>Date:</label><input type="date" name="date" /></div>
    <div><label>Date of Birth:</label><input type="date" name="dob" /></div>
  </div>

  <div class="main-content" id="printArea">
    <div class="split-container">
      <div class="form-section">
        <h2>Enter Required Values</h2>
        <form id="calcForm">
          {% csrf_token %}
          <table class="form-table">
            <tr><td><label>Amino Acids:</label></td><td><input type="text" name="amino_acids" /></td></tr>
            <tr><td><label>Lipids:</label></td><td><input type="text" name="Lipids" /></td></tr>
            <tr><td><label>Dextrose:</label></td><td><input type="text" name="dextrose" /></td></tr>
            <tr><td><label>Sodium:</label></td><td><input type="text" name="Sodium" /></td></tr>
            <tr><td><label>Potassium:</label></td><td><input type="text" name="Potassium" /></td></tr>
            <tr><td><label>Calcium:</label></td><td><input type="text" name="Calcium" /></td></tr>
            <tr><td><label>Body Weight:</label></td><td><input type="text" name="body_weight" /></td></tr>
            <tr><td><label>Fluid intake:</label></td><td><input type="text" name="Fluid_intake" /></td></tr>
            <tr><td><label>Feeds:</label></td><td><input type="text" name="Feeds" /></td></tr>
            <tr><td><label>Drugs:</label></td><td><input type="text" name="drugs" /></td></tr>
            <tr><td><label>Other losses:</label></td><td><input type="text" name="Other_losses_Sampling" /></td></tr>
            <tr><td><label>Spillage losses:</label></td><td><input type="text" name="add_as_spillage_losses" /></td></tr>
            <tr><td><label>Wastage factor:</label></td><td><input type="text" name="Wastage_factor" /></td></tr>
            <tr><td><label>Lower Conc. of Dextrose:</label></td><td><input type="text" name="Lower_Conc_of_Dextrose" /></td></tr>
            <tr><td><label>Higher Conc. of Dextrose:</label></td><td><input type="text" name="Higher_Conc_of_Dextrose" /></td></tr>
            <tr><td><label>% of Aminoacids:</label></td><td><input type="text" name="Percentage_Aminoacids" /></td></tr>
            <tr><td><label>% of Lipids:</label></td><td><input type="text" name="percentage_lipids" /></td></tr>
          </table>
        </form>
      </div>

      <div class="output-section">
        <h2>Output Section</h2>
        <table class="form-table">
            <tr><td><label>Calorie:Nitrogen Ratio:</label></td><td><div id="result23">---</div></td></tr>
            <tr><td><label>Total Fluid Volume:</label></td><td><div id="result01">---</div></td></tr>
            <tr><td><label>Total TPN Volume:</label></td><td><div id="result02">---</div></td></tr>
            <tr><td><label>Fat Volume:</label></td><td><div id="result03">---</div></td></tr>
            <tr><td><label>TPN Solution Ordered:</label></td><td><div id="result04">---</div></td></tr>
            <tr><td><label>Amino Acids Volume:</label></td><td><div id="result05">---</div></td></tr>
            <tr><td><label>Sodium Volume:</label></td><td><div id="result06">---</div></td></tr>
            <tr><td><label>Potassium Volume:</label></td><td><div id="result07">---</div></td></tr>
            <tr><td><label>Calcium Volume:</label></td><td><div id="result08">---</div></td></tr>
            <tr><td><label>Magnesium Volume:</label></td><td><div id="result09">---</div></td></tr>
            <tr><td><label>MVI Volume:</label></td><td><div id="result10">---</div></td></tr>
            <tr><td><label>Sum of Additive Volumes:</label></td><td><div id="result11">---</div></td></tr>
            <tr><td><label>Dextrose Absolute Amount:</label></td><td><div id="result12">---</div></td></tr>
            <tr><td><label>Dextrose Volume:</label></td><td><div id="result13">---</div></td></tr>
            <tr><td><label>Final Dextrose Concentration:</label></td><td><div id="result14">---</div></td></tr>
            <tr><td><label>Dextrose % for Calc:</label></td><td><div id="result15">---</div></td></tr>
            <tr><td><label>Volume of D1:</label></td><td><div id="result17">---</div></td></tr>
            <tr><td><label>Volume of D2:</label></td><td><div id="result16">---</div></td></tr>
            <tr><td><label>TPN Rate (ml/hr):</label></td><td><div id="result18">---</div></td></tr>
            <tr><td><label>Lipid Rate (ml/hr):</label></td><td><div id="result19">---</div></td></tr>
            <tr><td><label>Amino acid(in gram):</label></td><td><div id="result20">---</div></td></tr>
            <tr><td><label>Fat (in gram):</label></td><td><div id="result21">---</div></td></tr>
            <tr><td><label>Calorie (in gram):</label></td><td><div id="result22">---</div></td></tr>
        </table>
     </div>

    </div>
  </div>

  <div id="toast" style="position: fixed; bottom: 20px; right: 20px; background-color: #4caf50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 999;">
    üîÑ Calculations Updated!
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const form = document.getElementById('calcForm');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    form.addEventListener('input', function () {
      const formData = new FormData(form);
      if (!validateForm(form)) return;

      fetch('/calculate/', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        Object.entries(data).forEach(([key, value]) => {
          const el = document.getElementById(key);
          if (el) el.textContent = (value !== null && value !== undefined) ? value : '---';
        });
        showToast();
      })
      .catch(err => console.error("Error:", err));
    });

    function printResult() {
      window.print();
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("TPN Calculator Report", 10, 15);
      doc.setFontSize(12);
      const lines = [];
      for (let i = 1; i <= 19; i++) {
        const key = `result${i.toString().padStart(2, '0')}`;
        const val = document.getElementById(key)?.textContent || "---";
        lines.push(`${key.toUpperCase()}: ${val}`);
      }
      let y = 30;
      lines.forEach(line => {
        doc.text(line, 10, y);
        y += 8;
      });
      doc.save("TPN_Calculation_Report.pdf");
    }

    function showToast(message = "üîÑ Calculations Updated!") {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 2000);
    }

    function resetForm() {
      form.reset();
      document.querySelectorAll('.output-section div[id^="result"]').forEach(el => el.textContent = '---');
      showToast("üßπ Form cleared");
    }

    // Inject reset button
    const resetBtn = document.createElement("button");
    resetBtn.innerHTML = "‚ôª Reset";
    resetBtn.onclick = resetForm;
    document.querySelector(".navbar-buttons").appendChild(resetBtn);

    function validateForm(formEl) {
      let valid = true;
      const inputs = formEl.querySelectorAll('input[type="text"]');
      inputs.forEach(input => {
        const val = input.value.trim();
        if (val !== '' && isNaN(val)) {
          input.style.border = '2px solid red';
          valid = false;
        } else {
          input.style.border = '';
        }
      });
      return valid;
    }

    document.getElementById('themeToggle').addEventListener('change', function () {
      document.body.classList.toggle('light');
      localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });

    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light');
        document.getElementById('themeToggle').checked = true;
      }
    });
  </script>
</body>
</html>
